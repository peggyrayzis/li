#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR"

staged_files=()
while IFS= read -r file; do
	[[ -z "$file" ]] && continue
	staged_files+=("$file")
done < <(git diff --cached --name-only --diff-filter=ACMR)

if [[ "${#staged_files[@]}" -gt 0 ]]; then
	formattable=()
	for file in "${staged_files[@]}"; do
		case "$file" in
		*.ts|*.tsx|*.js|*.jsx|*.json|*.jsonc)
			if [[ -f "$file" ]]; then
				formattable+=("$file")
			fi
			;;
		esac
	done

	if [[ "${#formattable[@]}" -gt 0 ]]; then
		pnpm exec biome check --write --no-errors-on-unmatched "${formattable[@]}"
		git add "${formattable[@]}"
	fi
fi

npm run typecheck
